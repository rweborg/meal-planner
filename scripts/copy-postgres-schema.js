// Copy canonical Postgres schema over schema.prisma and fix migration_lock.toml
// so build and deploy always use Postgres (avoids P3019 and cached sqlite state).
const fs = require('fs');
const path = require('path');

const prismaDir = path.join(__dirname, '..', 'prisma');

// 1. Copy Postgres schema over schema.prisma
const schemaSrc = path.join(prismaDir, 'schema.postgres.prisma');
const schemaDest = path.join(prismaDir, 'schema.prisma');
fs.copyFileSync(schemaSrc, schemaDest);
console.log('copy-postgres-schema: copied schema.postgres.prisma -> schema.prisma');

// 2. Ensure migration_lock.toml says postgresql (fixes P3019 if cache had sqlite)
const lockPath = path.join(prismaDir, 'migrations', 'migration_lock.toml');
const lockContent = `# Please do not edit this file manually
# It should be added in your version-control system (i.e. Git)
provider = "postgresql"
`;
fs.writeFileSync(lockPath, lockContent);
console.log('copy-postgres-schema: set migration_lock.toml provider = postgresql');

// 3. Remove old SQLite migration folders so only the Postgres migration remains (fixes "2 migrations found")
const migrationsDir = path.join(prismaDir, 'migrations');
const oldSqliteMigrations = ['20260126165133_init', '20260126203819_add_recipe_details'];
for (const name of oldSqliteMigrations) {
  const dir = path.join(migrationsDir, name);
  if (fs.existsSync(dir)) {
    fs.rmSync(dir, { recursive: true });
    console.log('copy-postgres-schema: removed old SQLite migration', name);
  }
}
